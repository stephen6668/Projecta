<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Projecta Admin CMS</title>
  <style>
    :root {
      --bg: #f4efe8;
      --fg: #111;
      --border: #e6e2db;
      --focus: #1f6feb;
      --ok: #13a10e;
      --err: #c62828;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; background: var(--bg); color: var(--fg); }
    
    .login { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); z-index: 999; }
    .login-box { background: #fff; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
    .login-box h2 { margin-bottom: 20px; }
    .login-box input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; }
    .login-box button { width: 100%; padding: 12px; background: var(--fg); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
    .login-box button:disabled { opacity: 0.5; cursor: not-allowed; }
    .msg { margin-top: 10px; font-size: 13px; color: var(--err); }
    .info { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 15px; font-size: 13px; line-height: 1.6; }
    
    .admin { display: none; min-height: 100vh; }
    .header { background: #fff; padding: 15px 20px; border-bottom: 2px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
    .header h1 { font-size: 20px; }
    .header select { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; }
    .logout { padding: 8px 16px; background: var(--err); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
    
    .main { display: flex; gap: 20px; padding: 20px; max-width: 1400px; margin: 0 auto; }
    .sidebar { width: 300px; background: #fff; border-radius: 12px; padding: 20px; max-height: calc(100vh - 140px); overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
    .sidebar h3 { margin-bottom: 15px; font-size: 16px; }
    .sidebar button { width: 100%; padding: 10px; margin-bottom: 8px; border: 1px solid var(--border); background: #fff; cursor: pointer; border-radius: 6px; text-align: left; font-size: 14px; }
    .sidebar button:hover { background: var(--bg); }
    .sidebar button.active { background: var(--focus); color: #fff; border-color: var(--focus); }
    
    .group { font-weight: 600; font-size: 12px; color: #666; margin: 15px 0 8px; padding-top: 10px; border-top: 1px solid #eee; }
    .group:first-child { border-top: none; padding-top: 0; }
    
    .editor { flex: 1; background: #fff; border-radius: 12px; padding: 25px; max-height: calc(100vh - 140px); overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
    .editor h3 { margin-bottom: 20px; }
    .empty { color: #666; text-align: center; padding: 40px 20px; }
    
    .field { margin-bottom: 20px; }
    .field label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 14px; }
    .field input, .field textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; font-family: inherit; }
    .field textarea { min-height: 100px; resize: vertical; }
    .field input:focus, .field textarea:focus { outline: none; border-color: var(--focus); box-shadow: 0 0 0 3px rgba(31,111,235,0.1); }
    
    .save { padding: 12px 24px; background: var(--ok); color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
    .save:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .status { display: inline-block; padding: 8px 16px; border-radius: 6px; margin-left: 10px; font-size: 13px; font-weight: 600; }
    .status.ok { background: #e8f5e9; color: var(--ok); }
    .status.err { background: #ffebee; color: var(--err); }
    .status.wait { background: #e3f2fd; color: #1976d2; }
    
    .load { text-align: center; padding: 20px; color: #666; }
    
    @media(max-width:768px) {
      .main { flex-direction: column; }
      .sidebar { width: 100%; max-height: 300px; }
    }
  </style>
</head>
<body>

<div class="login" id="login">
  <div class="login-box">
    <h2>üîê Projecta Admin</h2>
    
    <div class="info">
      <strong>‚ÑπÔ∏è Appwrite 1.8.0</strong><br>
      Nutzt jetzt "Rows" statt "Documents"
    </div>
    
    <input type="text" id="endpoint" placeholder="Endpoint" value="https://cloud.appwrite.io/v1">
    <input type="text" id="project" placeholder="Project ID" value="68ee68b300144140da1c">
    <input type="text" id="database" placeholder="Database ID" value="68ee68c2001481512a67">
    <input type="text" id="table" placeholder="Table/Collection ID" value="8425229r23i32">
    <input type="email" id="email" placeholder="E-Mail" value="admin@projecta.lu">
    <input type="password" id="password" placeholder="Passwort">
    <button id="loginBtn">Anmelden</button>
    <div class="msg" id="msg"></div>
  </div>
</div>

<div class="admin" id="admin">
  <div class="header">
    <h1>üìù Projecta CMS</h1>
    <div>
      <select id="pageSelect">
        <option value="index">Home</option>
        <option value="product">Produkt</option>
        <option value="product-future">Zuk√ºnftige Produkte</option>
        <option value="necklace">Halskette</option>
        <option value="produkt-uebersicht">Produkt√ºbersicht</option>
      </select>
      <button class="logout" id="logout">Logout</button>
    </div>
  </div>

  <div class="main">
    <div class="sidebar">
      <h3>Bearbeitbare Bereiche</h3>
      <div id="list"></div>
    </div>

    <div class="editor">
      <div class="empty" id="empty">‚Üê W√§hle einen Bereich</div>
      <div id="edit" style="display:none"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/appwrite@16.0.2"></script>
<script>
const cfg = {};
let db, acc, currentPage, currentRowId, pageData = {};

const els = {
  login: document.getElementById('login'),
  admin: document.getElementById('admin'),
  msg: document.getElementById('msg'),
  list: document.getElementById('list'),
  edit: document.getElementById('edit'),
  empty: document.getElementById('empty'),
  pageSelect: document.getElementById('pageSelect')
};

const fields = {
  'produkt-uebersicht': [
    {id:'overview-title',label:'Titel',type:'text',group:'Seite'},
    {id:'overview-subtitle',label:'Untertitel',type:'textarea',group:'Seite'},
    {id:'product1-status',label:'Status',type:'text',group:'Produkt 1'},
    {id:'product1-img',label:'Bild',type:'image',group:'Produkt 1'},
    {id:'product1-title',label:'Titel',type:'text',group:'Produkt 1'},
    {id:'product1-desc',label:'Beschreibung',type:'textarea',group:'Produkt 1'},
    {id:'product1-price',label:'Preis',type:'text',group:'Produkt 1'},
    {id:'product1-btn',label:'Button',type:'text',group:'Produkt 1'},
    {id:'product2-status',label:'Status',type:'text',group:'Produkt 2'},
    {id:'product2-img',label:'Bild',type:'image',group:'Produkt 2'},
    {id:'product2-title',label:'Titel',type:'text',group:'Produkt 2'},
    {id:'product2-desc',label:'Beschreibung',type:'textarea',group:'Produkt 2'},
    {id:'product2-price',label:'Preis',type:'text',group:'Produkt 2'},
    {id:'product2-btn',label:'Button',type:'text',group:'Produkt 2'},
    {id:'product3-status',label:'Status',type:'text',group:'Produkt 3'},
    {id:'product3-img',label:'Bild',type:'image',group:'Produkt 3'},
    {id:'product3-title',label:'Titel',type:'text',group:'Produkt 3'},
    {id:'product3-desc',label:'Beschreibung',type:'textarea',group:'Produkt 3'},
    {id:'product3-price',label:'Preis',type:'text',group:'Produkt 3'},
    {id:'product3-btn',label:'Button',type:'text',group:'Produkt 3'},
    {id:'product4-status',label:'Status',type:'text',group:'Produkt 4'},
    {id:'product4-img',label:'Bild',type:'image',group:'Produkt 4'},
    {id:'product4-title',label:'Titel',type:'text',group:'Produkt 4'},
    {id:'product4-desc',label:'Beschreibung',type:'textarea',group:'Produkt 4'},
    {id:'product4-price',label:'Preis',type:'text',group:'Produkt 4'},
    {id:'product4-btn',label:'Button',type:'text',group:'Produkt 4'}
  ],
  'product-future': [
    {id:'future-title',label:'Titel',type:'text',group:'Produkt'},
    {id:'future-desc',label:'Beschreibung',type:'textarea',group:'Produkt'},
    {id:'future-price',label:'Preis',type:'text',group:'Produkt'},
    {id:'future-img',label:'Bild',type:'image',group:'Produkt'}
  ]
};

document.getElementById('loginBtn').onclick = async () => {
  const btn = document.getElementById('loginBtn');
  btn.disabled = true;
  els.msg.textContent = '‚è≥ Verbinde...';
  
  cfg.endpoint = document.getElementById('endpoint').value.trim();
  cfg.project = document.getElementById('project').value.trim();
  cfg.database = document.getElementById('database').value.trim();
  cfg.table = document.getElementById('table').value.trim();
  const email = document.getElementById('email').value.trim();
  const pass = document.getElementById('password').value;
  
  if (!cfg.endpoint || !cfg.project || !cfg.database || !cfg.table || !email || !pass) {
    els.msg.textContent = '‚ùå Alle Felder ausf√ºllen!';
    btn.disabled = false;
    return;
  }
  
  try {
    const client = new Appwrite.Client().setEndpoint(cfg.endpoint).setProject(cfg.project);
    db = new Appwrite.Databases(client);
    acc = new Appwrite.Account(client);
    
    try {
      await acc.get();
      console.log('‚úÖ Bereits eingeloggt');
    } catch {
      await acc.createEmailPasswordSession(email, pass);
      console.log('‚úÖ Login erfolgreich');
    }
    
    els.login.style.display = 'none';
    els.admin.style.display = 'block';
    loadPage('produkt-uebersicht');
  } catch (err) {
    console.error('Login Error:', err);
    els.msg.textContent = '‚ùå ' + (err.message || 'Fehler');
    btn.disabled = false;
  }
};

document.getElementById('logout').onclick = async () => {
  if (confirm('Abmelden?')) {
    try { await acc.deleteSession('current'); } catch {}
    location.reload();
  }
};

els.pageSelect.onchange = (e) => loadPage(e.target.value);

async function loadPage(page) {
  currentPage = page;
  els.list.innerHTML = '<div class="load">‚è≥ Lade...</div>';
  els.edit.style.display = 'none';
  els.empty.style.display = 'block';
  
  console.log('üîç Lade Seite:', page);
  
  try {
    // Appwrite 1.8.0 nutzt listDocuments (auch f√ºr Rows)
    const res = await db.listDocuments(cfg.database, cfg.table, [
      Appwrite.Query.equal('pageId', page),
      Appwrite.Query.limit(1)
    ]);
    
    console.log('üì¶ Response:', res);
    
    if (res.documents.length === 0) {
      els.list.innerHTML = `<div style="padding:15px;color:#666;line-height:1.8;">
        <strong>‚ùå Keine Daten</strong><br><br>
        Erstelle in Appwrite eine Row mit:<br>
        <strong>pageId:</strong> "${page}"<br><br>
        Dann f√ºge alle Felder hinzu!
      </div>`;
      return;
    }
    
    const row = res.documents[0];
    pageData[page] = row;
    currentRowId = row.$id;
    
    console.log('‚úÖ Row geladen:', row);
    
    if (fields[page]) {
      renderDirect(page, row);
    } else {
      els.list.innerHTML = '<div style="padding:15px;color:#666;">‚ùå Unbekannte Seite</div>';
    }
  } catch (err) {
    console.error('Load Error:', err);
    els.list.innerHTML = '<div style="padding:15px;color:red;">‚ùå ' + err.message + '</div>';
  }
}

function renderDirect(page, row) {
  els.list.innerHTML = '';
  let lastGroup = null;
  
  console.log('üé® Render Felder f√ºr:', page);
  
  fields[page].forEach(f => {
    if (f.group !== lastGroup) {
      const g = document.createElement('div');
      g.className = 'group';
      g.textContent = f.group;
      els.list.appendChild(g);
      lastGroup = f.group;
    }
    
    const btn = document.createElement('button');
    const hasValue = row[f.id] !== undefined && row[f.id] !== null;
    btn.textContent = f.label + (hasValue ? ' ‚úì' : ' ‚ö†Ô∏è');
    btn.style.opacity = hasValue ? '1' : '0.5';
    btn.onclick = () => editDirect(f, row);
    els.list.appendChild(btn);
    
    console.log(`  ${f.id}: ${hasValue ? '‚úì' : '‚ùå'} = ${row[f.id]}`);
  });
}

function editDirect(field, row) {
  els.list.querySelectorAll('button').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  
  els.empty.style.display = 'none';
  els.edit.style.display = 'block';
  
  const val = row[field.id] || '';
  let html = '<h3>‚úèÔ∏è ' + field.label + '</h3>';
  
  if (field.type === 'text') {
    html += '<div class="field"><label>' + field.label + '</label><input type="text" id="val" value="' + esc(val) + '"></div>';
  } else if (field.type === 'textarea') {
    html += '<div class="field"><label>' + field.label + '</label><textarea id="val" rows="6">' + esc(val) + '</textarea></div>';
  } else if (field.type === 'image') {
    html += '<div class="field"><label>Bild-URL</label><input type="url" id="val" value="' + esc(val) + '"></div>';
    html += '<div class="field"><label>Vorschau</label><img src="' + esc(val) + '" id="prev" style="max-width:100%;border-radius:8px;max-height:300px;" onerror="this.style.display=\'none\'"></div>';
  }
  
  html += '<button class="save" id="save">üíæ Speichern</button><span class="status" id="status" style="display:none"></span>';
  els.edit.innerHTML = html;
  
  if (field.type === 'image') {
    document.getElementById('val').oninput = (e) => {
      document.getElementById('prev').src = e.target.value;
      document.getElementById('prev').style.display = 'block';
    };
  }
  
  document.getElementById('save').onclick = () => saveDirect(field.id);
}

async function saveDirect(fieldId) {
  const btn = document.getElementById('save');
  const stat = document.getElementById('status');
  const val = document.getElementById('val').value;
  
  btn.disabled = true;
  stat.style.display = 'inline-block';
  stat.className = 'status wait';
  stat.textContent = '‚è≥ Speichert...';
  
  console.log('üíæ Speichere:', fieldId, '=', val);
  
  try {
    const upd = {};
    upd[fieldId] = val;
    
    await db.updateDocument(cfg.database, cfg.table, currentRowId, upd);
    pageData[currentPage][fieldId] = val;
    
    console.log('‚úÖ Gespeichert!');
    
    stat.className = 'status ok';
    stat.textContent = '‚úì Gespeichert';
    setTimeout(() => stat.style.display = 'none', 3000);
  } catch (err) {
    console.error('Save Error:', err);
    stat.className = 'status err';
    stat.textContent = '‚úó ' + err.message;
  } finally {
    btn.disabled = false;
  }
}

function esc(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}
</script>
</body>
</html>
